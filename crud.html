<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patient Management | BeClinic</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="crud.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>  
 
</head>

<body>
  <nav class="nav-bar">
    <div class="logo d-flex align-items-center">
      <div style="width: 50px; height: 50px; background: #2a6496; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">BC</div>
      <h1 class="ms-3">BECLINIC</h1>
    </div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="what_we_offer.html">Services</a></li>
      <li><a href="crud.html" class="active">CRUD</a></li>
    </ul>
  </nav>
  <div class="container">
    <h2 class="text-center mb-4 text-primary">ðŸ©º Manage Patient Medicine Records</h2>
    <div class="card p-4 mb-4">
      <h4 class="mb-3 text-secondary" id="form-title">Add New Medicine</h4>
      <form id="patientForm">
        <input type="hidden" id="editingId" value="">
        <div class="row g-3">
          <div class="col-md-4">
            <input type="text" class="form-control" id="name" placeholder="Medicine Name" required>
          </div>
          <div class="col-md-2">
            <input type="number" class="form-control" id="quantity" placeholder="Quantity" required>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="type">
              <option value="" selected disabled>Type</option>
              <option value="1">New</option>
              <option value="2">Used</option>
            </select>
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control" id="disease" placeholder="Note / Disease (optional)">
          </div>
        </div>
        <div class="mt-3 text-end">
          <button type="submit" class="btn btn-primary px-4" id="submitBtn">Add Medicine</button>
          <button type="button" class="btn btn-secondary px-4 d-none" id="cancelEdit">Cancel</button>
        </div>
      </form>
    </div>

    <div class="card p-3">
      <h4 class="mb-3 text-secondary">Medicine List</h4>
      <table class="table table-bordered text-center align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Medicine Name</th>
            <th>Quantity</th>
            <th>Type</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="patientTable">
        </tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    <p>Â© 2025 BeClinic | All Rights Reserved</p>
  </div>

  

  <script>

  const API_URL = "https://jsonplaceholder.typicode.com/posts";
let localCache = {}; 
  const $patientTable = $("#patientTable");
  const $patientForm = $("#patientForm");
  const $submitBtn = $("#submitBtn");
  const $cancelEditBtn = $("#cancelEdit");
  const $formTitle = $("#form-title");

  function typeLabel(val) {
    if (val === "1") return "New";
    if (val === "2") return "Used";
    return "Unknown";
  }

  function escapeHtml(text) {
    if (text === null || text === undefined) return "";
    return String(text)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function loadAllPosts() {
    $.get(API_URL)
      .done(function (posts) {
        renderTable(posts);
      })
      .fail(function () {
        $patientTable.html("<tr><td colspan='5'>Failed to load data.</td></tr>");
      });
  }

  function renderTable(posts) {
    if (!Array.isArray(posts) || posts.length === 0) {
      $patientTable.html("<tr><td colspan='5'>No records found.</td></tr>");
      return;
    }
 const rows = posts
      .map((p) => {
        return `
          <tr id="row-${p.id}">
            <td>${p.id}</td>
            <td>${escapeHtml(p.title)}</td>
            <td>${escapeHtml(p.body)}</td>
            <td>${typeLabel(String(p.userId))}</td>
            <td>
              <button class="btn btn-sm btn-warning" onclick="startEdit(${p.id})"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-danger" onclick="deletePost(${p.id})"><i class="bi bi-trash"></i></button>
            </td>
          </tr>`;
      })
      .join("");

    $patientTable.html(rows);
  }

  $patientForm.on("submit", function (e) {
    e.preventDefault();

    const editingId = $("#editingId").val();
    const name = $("#name").val().trim();
    const quantity = $("#quantity").val().trim();
    const type = $("#type").val();
    const disease = $("#disease").val().trim();

    const payload = {
      title: name,
      body: quantity + (disease ? " | Note: " + disease : ""),
      userId: type ? Number(type) : 1,
    };

    if (editingId) {
    
      $.ajax({
        url: `${API_URL}/${editingId}`,
        method: "PUT",
        contentType: "application/json",
        data: JSON.stringify({ id: Number(editingId), ...payload }),
        success: function (updated) {
          const rowHtml = `
            <td>${updated.id}</td>
            <td>${escapeHtml(updated.title)}</td>
            <td>${escapeHtml(updated.body)}</td>
            <td>${typeLabel(String(updated.userId))}</td>
            <td>
              <button class="btn btn-sm btn-warning" onclick="startEdit(${updated.id})"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-danger" onclick="deletePost(${updated.id})"><i class="bi bi-trash"></i></button>
            </td>`;
          $(`#row-${editingId}`).html(rowHtml);
          resetForm();
        },
        error: function () {
          alert("Failed to update the record.");
        },
      });
    } else {
    
      $.ajax({
        url: API_URL,
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(payload),
        success: function (created) {
          const row = `
            <tr id="row-${created.id}">
              <td>${created.id}</td>
              <td>${escapeHtml(created.title)}</td>
              <td>${escapeHtml(created.body)}</td>
              <td>${typeLabel(String(created.userId))}</td>
              <td>
                <button class="btn btn-sm btn-warning" onclick="startEdit(${created.id})"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-danger" onclick="deletePost(${created.id})"><i class="bi bi-trash"></i></button>
              </td>
            </tr>`;
          $patientTable.prepend(row);
          resetForm();
        },
        error: function () {
          alert("Failed to create record.");
        },
      });
    }
  });


  window.startEdit = function (id) {
    $.get(`${API_URL}/${id}`)
      .done(function (post) {
        $("#editingId").val(post.id);
        $("#name").val(post.title || "");
        const split = (post.body || "").split(" | Note: ");
        $("#quantity").val(split[0] || "");
        $("#disease").val(split[1] || "");
        $("#type").val(String(post.userId) || "1");

        $submitBtn.text("Update Medicine");
        $cancelEditBtn.removeClass("d-none");
        $formTitle.text("Edit Medicine");
        window.scrollTo({ top: 0, behavior: "smooth" });
      })
      .fail(function () {
        alert("Failed to fetch post details.");
      });
  };


  window.deletePost = function (id) {
    if (!confirm("Are you sure you want to delete this record?")) return;

    $.ajax({
      url: `${API_URL}/${id}`,
      method: "DELETE",
      success: function () {
        $(`#row-${id}`).remove();
      },
      error: function () {
        alert("Failed to delete record.");
      },
    });
  };


  $cancelEditBtn.on("click", function () {
    resetForm();
  });


  function resetForm() {
    $("#editingId").val("");
    $patientForm.trigger("reset");
    $submitBtn.text("Add Medicine");
    $cancelEditBtn.addClass("d-none");
    $formTitle.text("Add New Medicine");
  }

  $(document).ready(function () {
    loadAllPosts();
  });
</script>

</body>
</html>
